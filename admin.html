<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpLine - Painel de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .modal, .toast-container, .spinner-overlay { transition: opacity 0.3s ease; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 40px; height: 40px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <!-- TELA DE LOGIN -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <div class="flex justify-center mb-6">
                <div class="flex items-center">
                    <span class="w-12 h-12 bg-sky-600 text-white flex items-center justify-center rounded-lg text-2xl font-bold">U</span>
                    <h1 class="ml-3 text-3xl font-bold text-slate-800">UpLine</h1>
                </div>
            </div>
            <h2 class="text-center text-2xl font-semibold text-slate-700 mb-1">Acesso Gestor</h2>
            <form id="login-form" class="space-y-4 mt-8">
                <div>
                    <label for="admin-username" class="block text-sm font-medium text-slate-600">Utilizador</label>
                    <input type="text" id="admin-username" value="admin" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-slate-600">Senha</label>
                    <input type="password" id="admin-password" value="password" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="mt-8 w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 flex items-center justify-center">
                    <span class="btn-text">Entrar</span>
                    <div class="spinner hidden" style="width: 24px; height: 24px; border-width: 2px;"></div>
                </button>
                <div id="login-error" class="mt-4 text-center text-red-600 font-medium hidden"></div>
            </form>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL (Oculto por padrão) -->
    <div id="main-panel" class="hidden h-screen bg-slate-200">
        <!-- ... (código do painel principal, navegação, etc.) ... -->
    </div>
    
    <!-- Templates e Modals -->
    <!-- ... (código dos templates e modal de formulário) ... -->

    <!-- SPINNER OVERLAY GLOBAL -->
    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="spinner"></div>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://upline01.onrender.com';
            const state = { currentSection: '', editItemId: null, charts: {}, token: localStorage.getItem('upline_token'), cache: {} };

            const ui = {
                // ... (elementos da UI existentes) ...
                spinnerOverlay: document.getElementById('spinner-overlay'),
                toastContainer: document.getElementById('toast-container'),
            };

            // --- UX FEEDBACK FUNCTIONS ---
            const showSpinner = () => ui.spinnerOverlay.classList.remove('hidden');
            const hideSpinner = () => ui.spinnerOverlay.classList.add('hidden');

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `text-white px-6 py-3 rounded-md shadow-lg ${bgColor}`;
                toast.textContent = message;
                ui.toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };

            const setButtonLoading = (button, isLoading, originalText = '') => {
                const textSpan = button.querySelector('.btn-text');
                const spinner = button.querySelector('.spinner');
                if (isLoading) {
                    button.disabled = true;
                    if (textSpan) textSpan.classList.add('hidden');
                    if (spinner) spinner.classList.remove('hidden');
                } else {
                    button.disabled = false;
                    if (textSpan) textSpan.classList.remove('hidden');
                    if (spinner) spinner.classList.add('hidden');
                    if (textSpan && originalText) textSpan.textContent = originalText;
                }
            };

            // --- API REQUEST COM FEEDBACK ---
            const apiRequest = async (endpoint, method = 'GET', body = null) => {
                showSpinner();
                try {
                    const options = { method, headers: { 'Content-Type': 'application/json', 'x-access-token': state.token } };
                    if (body) options.body = JSON.stringify(body);
                    const response = await fetch(`${API_URL}/admin/${endpoint}`, options);
                    if (response.status === 401) {
                        handleLogout();
                        throw new Error('Sessão expirada. Por favor, faça login novamente.');
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Falha na requisição à API' }));
                        throw new Error(errorData.message || 'Erro desconhecido');
                    }
                    if (method !== 'DELETE' && response.status !== 204) return await response.json();
                } finally {
                    hideSpinner();
                }
            };
            
            // --- LÓGICA DE LOGIN COM FEEDBACK ---
            const handleLogin = async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button[type="submit"]');
                setButtonLoading(button, true);
                ui.loginError.classList.add('hidden');
                try {
                    // ... (lógica de fetch do login) ...
                } catch (error) {
                    // ... (tratamento de erro) ...
                } finally {
                    setButtonLoading(button, false, 'Entrar');
                }
            };

            // --- LÓGICA DE DELETE COM MODAL DE CONFIRMAÇÃO ---
            const handleDelete = async (id) => {
                openConfirmationModal(`Tem a certeza que deseja apagar o item #${id}?`, async () => {
                    try {
                        const singularEndpoint = state.currentSection.slice(0, -1);
                        await apiRequest(`${singularEndpoint}/${id}`, 'DELETE');
                        showToast('Item apagado com sucesso!', 'success');
                        await loadSection(`#${state.currentSection}`);
                    } catch (error) {
                        showToast(`Falha ao apagar o item: ${error.message}`, 'error');
                    }
                });
            };

            // --- SUBMISSÃO DE FORMULÁRIOS COM FEEDBACK ---
            const handleClienteSubmit = async (formData) => {
                const button = ui.genericForm.querySelector('button[type="submit"]');
                setButtonLoading(button, true);
                try {
                    // ... (lógica de submissão do cliente) ...
                    showToast(`Cliente ${state.editItemId ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                } finally {
                    setButtonLoading(button, false, state.editItemId ? 'Guardar Alterações' : 'Adicionar');
                }
            };
            
            // ... (aplicar o mesmo padrão de feedback a handleElevadorSubmit e handleTecnicoSubmit) ...

            // --- MODAL DE CONFIRMAÇÃO GENÉRICO ---
            const openConfirmationModal = (message, onConfirm) => {
                // Lógica para criar e mostrar um modal de confirmação
                // Substitui o `confirm()`
            };

            // --- INICIALIZAÇÃO E NAVEGAÇÃO ---
            // ... (código existente) ...
        });
    </script>
</body>
</html>
