<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpLine - Painel de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .modal { transition: opacity 0.3s ease; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex h-screen bg-slate-200">
        <!-- Barra Lateral de Navegação -->
        <aside class="w-64 bg-slate-800 text-white flex flex-col">
            <div class="flex items-center justify-center h-20 border-b border-slate-700">
                <span class="w-10 h-10 bg-sky-600 flex items-center justify-center rounded-lg text-xl font-bold">U</span>
                <h1 class="ml-3 text-2xl font-bold">UpLine</h1>
            </div>
            <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2">
                <a href="#dashboard" class="nav-link active flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Dashboard</a>
                <a href="#chamados" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Chamados</a>
                <a href="#clientes" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Clientes</a>
                <a href="#elevadores" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Elevadores</a>
                <a href="#tecnicos" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Técnicos</a>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm h-20 flex items-center justify-between px-6">
                <h2 id="page-title" class="text-2xl font-bold text-slate-800">Dashboard</h2>
            </header>
            <div id="content-area" class="flex-1 p-6 overflow-y-auto">
                <!-- As secções serão carregadas aqui -->
            </div>
        </main>
    </div>

    <!-- Templates para as secções -->
    <template id="dashboard-template">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-slate-500">Total de Chamados</h3>
                <p id="total-chamados" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-slate-500">Total de Técnicos</h3>
                <p id="total-tecnicos" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-slate-500">Total de Elevadores</h3>
                <p id="total-elevadores" class="text-3xl font-bold">0</p>
            </div>
        </div>
    </template>
    
    <template id="chamados-template">
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Endereço</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Técnico</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Abertura</th>
                    </tr></thead>
                    <tbody id="chamados-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </template>

    <template id="clientes-template">
        <div class="bg-white p-6 rounded-lg shadow">
            <button id="add-btn" class="mb-4 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700">Adicionar Cliente</button>
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Contrato Ativo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Ações</th>
                    </tr></thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </template>
    
    <template id="elevadores-template">
        <div class="bg-white p-6 rounded-lg shadow">
            <button id="add-btn" class="mb-4 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700">Adicionar Elevador</button>
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Código QR</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Endereço</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Cliente</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Ações</th>
                    </tr></thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </template>

    <template id="tecnicos-template">
        <div class="bg-white p-6 rounded-lg shadow">
            <button id="add-btn" class="mb-4 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700">Adicionar Técnico</button>
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Username</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Ações</th>
                    </tr></thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </template>

    <!-- Modal Genérico para Forms -->
    <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4 modal">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 id="form-modal-title" class="text-2xl font-bold mb-4"></h3>
            <form id="generic-form" class="space-y-4"></form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://upline01.onrender.com';
            const state = { currentSection: '', editItemId: null };

            const ui = {
                mainNav: document.getElementById('main-nav'),
                contentArea: document.getElementById('content-area'),
                pageTitle: document.getElementById('page-title'),
                formModal: document.getElementById('form-modal'),
                formModalTitle: document.getElementById('form-modal-title'),
                genericForm: document.getElementById('generic-form'),
            };

            const apiRequest = async (endpoint, method = 'GET', body = null) => {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(`${API_URL}/admin/${endpoint}`, options);
                if (!response.ok) throw new Error('Falha na requisição à API');
                return response.json();
            };

            const closeModal = () => {
                ui.formModal.classList.add('hidden');
                ui.genericForm.innerHTML = '';
                state.editItemId = null;
            };

            const openModal = (title, formHtml, submitHandler) => {
                ui.formModalTitle.textContent = title;
                ui.genericForm.innerHTML = formHtml;
                ui.formModal.classList.remove('hidden');
                ui.genericForm.onsubmit = async (e) => {
                    e.preventDefault();
                    await submitHandler(new FormData(ui.genericForm));
                };
                // Adiciona botão de cancelar
                const cancelButton = ui.genericForm.querySelector('.cancel-btn');
                if (cancelButton) cancelButton.onclick = closeModal;
            };

            const renderTable = (data, headers, rowRenderer) => {
                const tableBody = document.getElementById('data-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = rowRenderer(item);
                    row.querySelector('.edit-btn')?.addEventListener('click', () => openEditModal(item));
                    row.querySelector('.delete-btn')?.addEventListener('click', () => handleDelete(item.id));
                });
            };

            // --- Lógica de Clientes ---
            const loadClientesData = async () => {
                const clientes = await apiRequest('clientes');
                renderTable(clientes, ['ID', 'Nome', 'Contrato'], item => `
                    <td class="px-6 py-4 whitespace-nowrap">${item.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.possui_contrato ? 'Sim' : 'Não'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${item.id}" class="edit-btn text-sky-600 hover:text-sky-900">Editar</button>
                        <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-900 ml-4">Apagar</button>
                    </td>`);
                document.getElementById('add-btn').onclick = () => openAddClienteModal();
            };

            const openAddClienteModal = () => {
                const formHtml = `
                    <div><label class="block text-sm">Nome do Cliente</label><input name="nome" type="text" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div class="flex items-center"><input name="possui_contrato" type="checkbox" class="h-4 w-4 rounded"><label class="ml-2">Possui Contrato Ativo</label></div>
                    <div class="pt-4 flex justify-end gap-4">
                        <button type="button" class="cancel-btn bg-slate-200 px-4 py-2 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-sky-600 text-white px-4 py-2 rounded-lg">Guardar</button>
                    </div>`;
                openModal('Adicionar Novo Cliente', formHtml, handleClienteSubmit);
            };
            
            const handleClienteSubmit = async (formData) => {
                const data = {
                    nome: formData.get('nome'),
                    possui_contrato: formData.get('possui_contrato') === 'on',
                };
                await apiRequest('clientes', 'POST', data);
                closeModal();
                await loadClientesData();
            };
            
            // --- Lógica de Elevadores ---
            const loadElevadoresData = async () => {
                const elevadores = await apiRequest('elevadores');
                renderTable(elevadores, ['Código QR', 'Endereço', 'Cliente'], item => `
                    <td class="px-6 py-4 whitespace-nowrap">${item.codigo_qr}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.endereco}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.cliente_nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${item.id}" class="edit-btn text-sky-600 hover:text-sky-900">Editar</button>
                        <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-900 ml-4">Apagar</button>
                    </td>`);
                document.getElementById('add-btn').onclick = () => openAddElevadorModal();
            };

            const openAddElevadorModal = async () => {
                const clientes = await apiRequest('clientes');
                const options = clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-sm">Código QR</label><input name="codigo_qr" type="text" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div><label class="block text-sm">Endereço</label><input name="endereco" type="text" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div><label class="block text-sm">Latitude</label><input name="latitude" type="number" step="any" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div><label class="block text-sm">Longitude</label><input name="longitude" type="number" step="any" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div><label class="block text-sm">Cliente</label><select name="cliente_id" required class="mt-1 block w-full border-slate-300 rounded-md">${options}</select></div>
                    <div class="pt-4 flex justify-end gap-4">
                        <button type="button" class="cancel-btn bg-slate-200 px-4 py-2 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-sky-600 text-white px-4 py-2 rounded-lg">Guardar</button>
                    </div>`;
                openModal('Adicionar Novo Elevador', formHtml, handleElevadorSubmit);
            };

             const handleElevadorSubmit = async (formData) => {
                const data = Object.fromEntries(formData.entries());
                await apiRequest('elevadores', 'POST', data);
                closeModal();
                await loadElevadoresData();
            };

            // --- Lógica de Técnicos ---
             const loadTecnicosData = async () => {
                const tecnicos = await apiRequest('tecnicos');
                renderTable(tecnicos, ['ID', 'Nome', 'Username'], item => `
                    <td class="px-6 py-4 whitespace-nowrap">${item.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${item.id}" class="edit-btn text-sky-600 hover:text-sky-900">Editar</button>
                        <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-900 ml-4">Apagar</button>
                    </td>`);
                document.getElementById('add-btn').onclick = () => openAddTecnicoModal();
            };

            const openAddTecnicoModal = () => {
                const formHtml = `
                    <div><label class="block text-sm">Nome Completo</label><input name="nome" type="text" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div><label class="block text-sm">Username (para login)</label><input name="username" type="text" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div><label class="block text-sm">Senha</label><input name="password" type="password" required class="mt-1 block w-full border-slate-300 rounded-md"></div>
                    <div class="pt-4 flex justify-end gap-4">
                        <button type="button" class="cancel-btn bg-slate-200 px-4 py-2 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-sky-600 text-white px-4 py-2 rounded-lg">Guardar</button>
                    </div>`;
                openModal('Adicionar Novo Técnico', formHtml, handleTecnicoSubmit);
            };

            const handleTecnicoSubmit = async (formData) => {
                const data = Object.fromEntries(formData.entries());
                await apiRequest('tecnicos', 'POST', data);
                closeModal();
                await loadTecnicosData();
            };
            
            // --- Funções de Carregamento Genéricas ---
            const loadSection = async (hash) => {
                const section = hash.substring(1) || 'dashboard';
                state.currentSection = section;
                pageTitle.textContent = section.charAt(0).toUpperCase() + section.slice(1);
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if(link.getAttribute('href') === `#${section}`) link.classList.add('active');
                });
                const template = document.getElementById(`${section}-template`);
                if (template) {
                    contentArea.innerHTML = template.innerHTML;
                    const dataLoaders = {
                        'dashboard': loadDashboardData,
                        'chamados': loadChamadosData,
                        'clientes': loadClientesData,
                        'elevadores': loadElevadoresData,
                        'tecnicos': loadTecnicosData,
                    };
                    if (dataLoaders[section]) await dataLoaders[section]();
                } else {
                    contentArea.innerHTML = `<p>Secção não encontrada.</p>`;
                }
            };
            
            const loadDashboardData = async () => {
                const [chamados, tecnicos, elevadores] = await Promise.all([
                    apiRequest('chamados'),
                    apiRequest('tecnicos'),
                    apiRequest('elevadores')
                ]);
                document.getElementById('total-chamados').textContent = chamados.length;
                document.getElementById('total-tecnicos').textContent = tecnicos.length;
                document.getElementById('total-elevadores').textContent = elevadores.length;
            };

            const loadChamadosData = async () => {
                const chamados = await apiRequest('chamados');
                const tableBody = document.getElementById('chamados-table-body');
                tableBody.innerHTML = '';
                chamados.forEach(c => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${c.id_chamado}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c.status === 'finalizado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${c.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap">${c.endereco}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${c.tecnico_responsavel}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${c.data_abertura}</td>`;
                });
            };

            // --- Inicialização e Navegação ---
            mainNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'A' && e.target.href) {
                    e.preventDefault();
                    window.location.hash = new URL(e.target.href).hash;
                }
            });

            window.addEventListener('hashchange', () => loadSection(window.location.hash));
            loadSection(window.location.hash || '#dashboard');
        });
    </script>
</body>
</ht
