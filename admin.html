<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpLine - Painel de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .modal, .toast-container, .spinner-overlay { transition: opacity 0.3s ease; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 40px; height: 40px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <!-- TELA DE LOGIN -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <div class="flex justify-center mb-6">
                <div class="flex items-center">
                    <span class="w-12 h-12 bg-sky-600 text-white flex items-center justify-center rounded-lg text-2xl font-bold">U</span>
                    <h1 class="ml-3 text-3xl font-bold text-slate-800">UpLine</h1>
                </div>
            </div>
            <h2 class="text-center text-2xl font-semibold text-slate-700 mb-1">Acesso Gestor</h2>
            <form id="login-form" class="space-y-4 mt-8">
                <div>
                    <label for="admin-username" class="block text-sm font-medium text-slate-600">Utilizador</label>
                    <input type="text" id="admin-username" value="admin" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-slate-600">Senha</label>
                    <input type="password" id="admin-password" value="password" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="mt-8 w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 flex items-center justify-center">
                    <span class="btn-text">Entrar</span>
                    <div class="spinner hidden" style="width: 24px; height: 24px; border-width: 2px;"></div>
                </button>
                <div id="login-error" class="mt-4 text-center text-red-600 font-medium hidden"></div>
            </form>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL (Oculto por padrão) -->
    <div id="main-panel" class="hidden">
        <div class="flex h-screen bg-slate-200">
            <!-- Barra Lateral de Navegação -->
            <aside class="w-64 bg-slate-800 text-white flex flex-col">
                <div class="flex items-center justify-center h-20 border-b border-slate-700">
                    <span class="w-10 h-10 bg-sky-600 flex items-center justify-center rounded-lg text-xl font-bold">U</span>
                    <h1 class="ml-3 text-2xl font-bold">UpLine</h1>
                </div>
                <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2">
                    <a href="#dashboard" class="nav-link active flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Dashboard</a>
                    <a href="#chamados" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Chamados</a>
                    <a href="#clientes" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Clientes</a>
                    <a href="#elevadores" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Elevadores</a>
                    <a href="#tecnicos" class="nav-link flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Técnicos</a>
                </nav>
                <div class="px-4 py-4 border-t border-slate-700">
                    <button id="logout-btn" class="w-full text-left flex items-center px-4 py-2 rounded-lg hover:bg-slate-700">Sair</button>
                </div>
            </aside>

            <!-- Conteúdo Principal -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-sm h-20 flex items-center justify-between px-6">
                    <h2 id="page-title" class="text-2xl font-bold text-slate-800">Dashboard</h2>
                </header>
                <div id="content-area" class="flex-1 p-6 overflow-y-auto">
                    <!-- As secções serão carregadas aqui -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- Templates e Modals -->
    <template id="dashboard-template">
        <!-- ... (código do template do dashboard) ... -->
    </template>
    <template id="chamados-template">
        <!-- ... (código do template de chamados) ... -->
    </template>
    <template id="clientes-template">
        <!-- ... (código do template de clientes) ... -->
    </template>
    <template id="elevadores-template">
        <!-- ... (código do template de elevadores) ... -->
    </template>
    <template id="tecnicos-template">
        <!-- ... (código do template de tecnicos) ... -->
    </template>

    <!-- Modal Genérico para Forms -->
    <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4 modal">
        <!-- ... (código do modal de formulário) ... -->
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <p id="modal-text" class="mb-4 text-lg">Tem a certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="bg-slate-300 px-6 py-2 rounded-lg hover:bg-slate-400">Cancelar</button>
                <button id="modal-confirm-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SPINNER OVERLAY GLOBAL -->
    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="spinner"></div>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://upline01.onrender.com';
            const state = { currentSection: '', editItemId: null, charts: {}, token: localStorage.getItem('upline_token'), cache: {} };

            const ui = {
                loginSection: document.getElementById('login-section'),
                mainPanel: document.getElementById('main-panel'),
                loginForm: document.getElementById('login-form'),
                logoutBtn: document.getElementById('logout-btn'),
                loginError: document.getElementById('login-error'),
                mainNav: document.getElementById('main-nav'),
                contentArea: document.getElementById('content-area'),
                pageTitle: document.getElementById('page-title'),
                formModal: document.getElementById('form-modal'),
                formModalTitle: document.getElementById('form-modal-title'),
                genericForm: document.getElementById('generic-form'),
                spinnerOverlay: document.getElementById('spinner-overlay'),
                toastContainer: document.getElementById('toast-container'),
                confirmationModal: document.getElementById('confirmation-modal'),
                modalText: document.getElementById('modal-text'),
                modalConfirmBtn: document.getElementById('modal-confirm-btn'),
                modalCancelBtn: document.getElementById('modal-cancel-btn'),
            };

            // --- UX FEEDBACK FUNCTIONS ---
            const showSpinner = () => ui.spinnerOverlay.classList.remove('hidden');
            const hideSpinner = () => ui.spinnerOverlay.classList.add('hidden');

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `text-white px-6 py-3 rounded-md shadow-lg animate-pulse`;
                toast.textContent = message;
                ui.toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };

            const setButtonLoading = (button, isLoading, originalText = '') => {
                const textSpan = button.querySelector('.btn-text');
                const spinner = button.querySelector('.spinner');
                button.disabled = isLoading;
                if (textSpan) textSpan.style.display = isLoading ? 'none' : 'inline';
                if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
                if (!isLoading && textSpan && originalText) textSpan.textContent = originalText;
            };

            const openConfirmationModal = (message, onConfirm) => {
                ui.modalText.textContent = message;
                ui.confirmationModal.classList.remove('hidden');
                ui.modalConfirmBtn.onclick = () => {
                    onConfirm();
                    ui.confirmationModal.classList.add('hidden');
                };
                ui.modalCancelBtn.onclick = () => ui.confirmationModal.classList.add('hidden');
            };

            // --- API REQUEST COM FEEDBACK ---
            const apiRequest = async (endpoint, method = 'GET', body = null) => {
                showSpinner();
                try {
                    const options = { method, headers: { 'Content-Type': 'application/json', 'x-access-token': state.token } };
                    if (body) options.body = JSON.stringify(body);
                    const response = await fetch(`${API_URL}/admin/${endpoint}`, options);
                    if (response.status === 401) {
                        handleLogout();
                        throw new Error('Sessão expirada. Por favor, faça login novamente.');
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Falha na requisição à API' }));
                        throw new Error(errorData.message || 'Erro desconhecido');
                    }
                    if (method !== 'DELETE' && response.status !== 204) return await response.json();
                } finally {
                    hideSpinner();
                }
            };
            
            // --- LÓGICA DE LOGIN COM FEEDBACK ---
            const handleLogin = async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button[type="submit"]');
                setButtonLoading(button, true);
                ui.loginError.classList.add('hidden');
                try {
                    const username = document.getElementById('admin-username').value;
                    const password = document.getElementById('admin-password').value;
                    const response = await fetch(`${API_URL}/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.token = data.token;
                        localStorage.setItem('upline_token', data.token);
                        showMainPanel();
                    } else {
                        throw new Error(data.message || 'Erro ao fazer login.');
                    }
                } catch (error) {
                    ui.loginError.textContent = error.message;
                    ui.loginError.classList.remove('hidden');
                } finally {
                    setButtonLoading(button, false, 'Entrar');
                }
            };
            
            const handleLogout = () => {
                state.token = null;
                state.cache = {};
                localStorage.removeItem('upline_token');
                ui.mainPanel.classList.add('hidden');
                ui.loginSection.classList.remove('hidden');
            };

            const showMainPanel = () => {
                ui.loginSection.classList.add('hidden');
                ui.mainPanel.classList.remove('hidden');
                ui.mainPanel.style.display = 'flex';
                loadSection(window.location.hash || '#dashboard');
            };

            // --- LÓGICA DE DELETE COM MODAL DE CONFIRMAÇÃO ---
            const handleDelete = async (id) => {
                openConfirmationModal(`Tem a certeza que deseja apagar o item #${id}?`, async () => {
                    try {
                        const singularEndpoint = state.currentSection.slice(0, -1);
                        await apiRequest(`${singularEndpoint}/${id}`, 'DELETE');
                        showToast('Item apagado com sucesso!', 'success');
                        await loadSection(`#${state.currentSection}`);
                    } catch (error) {
                        showToast(`Falha ao apagar o item: ${error.message}`, 'error');
                    }
                });
            };

            // --- SUBMISSÃO DE FORMULÁRIOS COM FEEDBACK ---
            const handleFormSubmit = async (formData, endpointSingular, endpointPlural, loadDataFunction) => {
                const button = ui.genericForm.querySelector('button[type="submit"]');
                setButtonLoading(button, true);
                try {
                    const data = Object.fromEntries(formData.entries());
                    // Lógica específica para checkbox
                    if (formData.has('possui_contrato')) {
                        data.possui_contrato = formData.get('possui_contrato') === 'on';
                    }
                    const method = state.editItemId ? 'PUT' : 'POST';
                    const endpoint = state.editItemId ? `${endpointSingular}/${state.editItemId}` : endpointPlural;
                    await apiRequest(endpoint, method, data);
                    closeModal();
                    showToast(`Registo ${state.editItemId ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                    await loadDataFunction();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                } finally {
                    setButtonLoading(button, false, state.editItemId ? 'Guardar Alterações' : 'Adicionar');
                }
            };

            const handleClienteSubmit = (formData) => handleFormSubmit(formData, 'cliente', 'clientes', loadClientesData);
            const handleElevadorSubmit = (formData) => handleFormSubmit(formData, 'elevador', 'elevadores', loadElevadoresData);
            const handleTecnicoSubmit = (formData) => handleFormSubmit(formData, 'tecnico', 'tecnicos', loadTecnicosData);

            // --- INICIALIZAÇÃO E NAVEGAÇÃO ---
            // ... (código existente para loadSection, loadDashboardData, etc., mas sem as funções de submissão) ...
            
            // --- Inicialização ---
            if (state.token) {
                showMainPanel();
            } else {
                ui.loginSection.classList.remove('hidden');
            }
            
            ui.loginForm.addEventListener('submit', handleLogin);
            ui.logoutBtn.addEventListener('click', handleLogout);
            ui.mainNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'A' && e.target.href) {
                    e.preventDefault();
                    window.location.hash = new URL(e.target.href).hash;
                }
            });
            window.addEventListener('hashchange', () => loadSection(window.location.hash));
        });
    </script>
</body>
</html>
